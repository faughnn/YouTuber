{% extends "base.html" %}

{% block title %}Pipeline Control - YouTube Pipeline UI{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 sm:py-8">
        <!-- Enhanced Page Header -->
        <div class="mb-8 fade-in">
            <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
                <div class="flex-1">
                    <div class="flex items-center space-x-3 mb-2">
                        <div class="p-2 bg-blue-100 rounded-lg">
                            <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12 6.5-12 6.5z"></path>
                            </svg>
                        </div>
                        <div>
                            <h1 class="text-2xl sm:text-3xl font-bold text-gray-900">Pipeline Control Center</h1>
                            <p class="mt-1 text-sm sm:text-base text-gray-600">Execute and monitor your YouTube processing pipeline with flexible stage selection</p>
                        </div>
                    </div>
                    
                    <!-- Breadcrumb -->
                    <nav class="flex" aria-label="Breadcrumb">
                        <ol class="flex items-center space-x-2 text-sm">
                            <li><a href="{{ url_for('main.index') }}" class="text-gray-500 hover:text-gray-700 transition-colors">Dashboard</a></li>
                            <li><span class="text-gray-400">/</span></li>
                            <li><span class="text-gray-900 font-medium">Pipeline</span></li>
                        </ol>
                    </nav>
                </div>
                
                <div class="flex gap-3">
                    <!-- Help Button -->
                    <button type="button" 
                            class="btn btn-secondary flex items-center gap-2"
                            onclick="window.uiEnhancements?.showHelp('pipeline')"
                            aria-label="Show pipeline help">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span class="hidden sm:inline">Help</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Configuration Error Alert -->
        {% if config.error %}
        <div class="mb-8 bg-red-50 border-l-4 border-red-400 rounded-lg p-4 fade-in" role="alert">
            <div class="flex">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-red-400" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                    </svg>
                </div>
                <div class="ml-3">
                    <h3 class="text-sm font-medium text-red-800">Pipeline Configuration Error</h3>
                    <div class="mt-2 text-sm text-red-700">
                        <p>{{ config.error }}</p>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}        <!-- Enhanced Pipeline Execution Form -->
        <div class="bg-white shadow-lg rounded-xl mb-8 fade-in">
            <div class="px-6 py-6 sm:p-8">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center space-x-3">
                        <div class="p-2 bg-blue-100 rounded-lg">
                            <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12 6.5-12 6.5z"></path>
                            </svg>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-900">Execute Pipeline</h3>
                    </div>
                    <button type="button" 
                            class="text-sm text-gray-500 hover:text-gray-700 transition-colors"
                            onclick="window.uiEnhancements?.showHelp('pipeline-execution')"
                            aria-label="Help with pipeline execution">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </button>
                </div>
                
                <form id="pipeline-form" class="space-y-6">
                    <!-- YouTube URL Input -->
                    <div>
                        <label for="youtube-url" class="block text-sm font-medium text-gray-700 mb-2">YouTube URL</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <svg class="h-5 w-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM4.332 8.027a6.012 6.012 0 011.912-2.706C6.512 5.73 6.974 6 7.5 6A1.5 1.5 0 019 7.5V8a2 2 0 004 0 2 2 0 011.523-1.943A5.977 5.977 0 0116 10c0 .34-.028.675-.083 1H15a2 2 0 00-2 2v2.197A5.973 5.973 0 0110 16v-2a2 2 0 00-2-2 2 2 0 01-2-2 2 2 0 00-1.668-1.973z" clip-rule="evenodd" />
                                </svg>
                            </div>
                            <input type="url" 
                                   id="youtube-url" 
                                   name="youtube_url" 
                                   required
                                   class="form-input pl-10 w-full"
                                   placeholder="https://www.youtube.com/watch?v=dQw4w9WgXcQ"
                                   aria-describedby="url-help">
                            <button type="button" 
                                    id="validate-url" 
                                    class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600"
                                    aria-label="Validate YouTube URL">
                                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </button>
                        </div>
                        <p id="url-help" class="mt-1 text-xs text-gray-500">Enter a valid YouTube video URL to process</p>
                    </div>

                    <!-- Pipeline Stages Selection -->
                    <div>
                        <div class="flex items-center justify-between mb-4">
                            <label class="block text-sm font-medium text-gray-700">Pipeline Stages</label>
                            <div class="flex space-x-2">
                                <button type="button" 
                                        id="select-all-stages" 
                                        class="text-xs text-blue-600 hover:text-blue-800 font-medium"
                                        aria-label="Select all pipeline stages">
                                    Select All
                                </button>
                                <span class="text-xs text-gray-400">|</span>
                                <button type="button" 
                                        id="clear-all-stages" 
                                        class="text-xs text-gray-600 hover:text-gray-800 font-medium"
                                        aria-label="Clear all pipeline stages">
                                    Clear All
                                </button>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3" role="group" aria-labelledby="stages-legend">
                            {% if config.stages %}
                                {% for stage_num, stage_name in config.stages.items() %}
                                    <div class="stage-card relative flex items-start p-4 bg-gray-50 rounded-lg border border-gray-200 hover:border-gray-300 transition-colors">
                                        <div class="flex items-center h-5">
                                            <input id="stage-{{ stage_num }}" 
                                                   name="selected_stages" 
                                                   type="checkbox" 
                                                   value="{{ stage_num }}" 
                                                   class="form-checkbox h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                                                   aria-describedby="stage-{{ stage_num }}-desc">
                                        </div>
                                        <div class="ml-3 flex-1">
                                            <label for="stage-{{ stage_num }}" class="block text-sm font-medium text-gray-900 cursor-pointer">
                                                <span class="stage-indicator bg-blue-100 text-blue-800">{{ stage_num }}</span>
                                                Stage {{ stage_num }}
                                            </label>
                                            <p id="stage-{{ stage_num }}-desc" class="text-xs text-gray-600 mt-1">{{ stage_name }}</p>
                                        </div>
                                    </div>
                                {% endfor %}
                            {% endif %}
                        </div>
                    </div>
                </div>                <!-- Audio Method Selection -->
                <div id="audio-method-section" style="display: none;">
                    <label class="block text-sm font-medium text-gray-700 mb-3">Audio Generation Method</label>
                    <div class="space-y-2">
                        <div class="flex items-center">
                            <input id="audio-tts" name="audio_method" type="radio" value="tts" checked class="form-checkbox">
                            <label for="audio-tts" class="ml-3 text-sm font-medium text-gray-700">
                                Text-to-Speech (TTS) - Automatic generation
                            </label>
                        </div>
                        <div class="flex items-center">
                            <input id="audio-manual" name="audio_method" type="radio" value="manual" class="form-checkbox">
                            <label for="audio-manual" class="ml-3 text-sm font-medium text-gray-700">
                                Manual Upload - Use custom audio files
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Manual Audio Upload Section -->
                <div id="manual-audio-section" style="display: none;" class="bg-gray-50 rounded-lg p-4 border-2 border-dashed border-gray-300">
                    <div class="text-center">
                        <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                            <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                        <div class="mt-4">
                            <label for="audio-files" class="cursor-pointer">
                                <span class="mt-2 block text-sm font-medium text-gray-900">
                                    Drop audio files here or click to browse
                                </span>
                                <input id="audio-files" name="audio_files" type="file" class="sr-only" multiple accept=".mp3,.wav,.aac,.m4a">
                            </label>
                            <p class="mt-1 text-xs text-gray-500">
                                Supported formats: MP3, WAV, AAC, M4A (max 50MB per file)
                            </p>
                        </div>
                    </div>
                    
                    <!-- Audio File List -->
                    <div id="audio-file-list" class="mt-4" style="display: none;">
                        <h4 class="text-sm font-medium text-gray-900 mb-2">Uploaded Audio Files:</h4>
                        <div id="audio-files-container" class="space-y-2"></div>
                    </div>
                    
                    <!-- Upload Progress -->
                    <div id="upload-progress" class="mt-4" style="display: none;">
                        <div class="flex items-center justify-between text-sm text-gray-600 mb-1">
                            <span id="upload-status">Uploading files...</span>
                            <span id="upload-percentage">0%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div id="upload-progress-bar" class="bg-primary-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <!-- Prompt Management Section -->
                <div id="prompt-management-section" style="display: none;">
                    <label class="block text-sm font-medium text-gray-700 mb-3">Narrative Prompts</label>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Stage 3 Analysis Prompts -->
                        <div>
                            <label for="stage3-prompt" class="block text-xs font-medium text-gray-600 mb-1">Stage 3 Analysis Prompt</label>
                            <select id="stage3-prompt" name="stage3_prompt" class="form-select w-full">
                                <option value="">Select analysis prompt...</option>
                            </select>
                        </div>
                        
                        <!-- Stage 4 Narrative Prompts -->
                        <div>
                            <label for="stage4-prompt" class="block text-xs font-medium text-gray-600 mb-1">Stage 4 Narrative Prompt</label>
                            <select id="stage4-prompt" name="stage4_prompt" class="form-select w-full">
                                <option value="">Select narrative prompt...</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Custom Prompt Creation -->
                    <div class="mt-4">
                        <button type="button" id="create-custom-prompt" class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                            </svg>
                            Create Custom Prompt
                        </button>
                    </div>
                </div>

                <!-- Execution Mode -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-3">Execution Mode</label>
                    <div class="space-y-2">
                        <div class="flex items-center">
                            <input id="mode-full" name="execution_mode" type="radio" value="full" checked class="form-checkbox">
                            <label for="mode-full" class="ml-3 text-sm font-medium text-gray-700">
                                Full Pipeline (All selected stages)
                            </label>
                        </div>
                        <div class="flex items-center">
                            <input id="mode-audio" name="execution_mode" type="radio" value="audio-only" class="form-checkbox">
                            <label for="mode-audio" class="ml-3 text-sm font-medium text-gray-700">
                                Audio Only (Stages 1-5)
                            </label>
                        </div>
                        <div class="flex items-center">
                            <input id="mode-script" name="execution_mode" type="radio" value="script-only" class="form-checkbox">
                            <label for="mode-script" class="ml-3 text-sm font-medium text-gray-700">
                                Script Only (Stages 1-4)
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Submit Button -->
                <div class="flex justify-end">
                    <button type="submit" class="btn-primary">
                        ðŸš€ Start Pipeline
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Pipeline Status (placeholder) -->
    <div id="pipeline-status" class="bg-white shadow rounded-lg hidden">
        <div class="px-4 py-5 sm:p-6">
            <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Pipeline Status</h3>
            <div id="status-content">
                <!-- Status content will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Development Note -->
    <div class="mt-8 bg-blue-50 border border-blue-200 rounded-lg p-4">
        <div class="flex">
            <div class="flex-shrink-0">
                <svg class="h-5 w-5 text-blue-400" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                </svg>
            </div>
            <div class="ml-3">
                <h3 class="text-sm font-medium text-blue-800">Phase 1 Foundation</h3>
                <div class="mt-2 text-sm text-blue-700">
                    <p>Pipeline control interface ready. Master processor integration will be implemented in Phase 2.</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Global variables for audio upload
let uploadedAudioFiles = new Map();
let availablePrompts = {
    stage3: [],
    stage4: []
};

// Initialize page functionality
document.addEventListener('DOMContentLoaded', function() {
    initializeStageSelection();
    initializeAudioUpload();
    initializePromptManagement();
    loadAvailablePrompts();
});

// Stage selection logic
function initializeStageSelection() {
    const stageCheckboxes = document.querySelectorAll('input[name="selected_stages"]');
    const audioMethodSection = document.getElementById('audio-method-section');
    const promptSection = document.getElementById('prompt-management-section');
    
    function updateVisibility() {
        const selectedStages = Array.from(stageCheckboxes)
            .filter(cb => cb.checked)
            .map(cb => parseInt(cb.value));
        
        // Show audio method selection if Stage 5 is selected
        if (selectedStages.includes(5)) {
            audioMethodSection.style.display = 'block';
        } else {
            audioMethodSection.style.display = 'none';
            document.getElementById('manual-audio-section').style.display = 'none';
        }
        
        // Show prompt management for stages 3 or 4
        if (selectedStages.includes(3) || selectedStages.includes(4)) {
            promptSection.style.display = 'block';
        } else {
            promptSection.style.display = 'none';
        }
    }
    
    stageCheckboxes.forEach(cb => {
        cb.addEventListener('change', updateVisibility);
    });
    
    updateVisibility();
}

// Audio upload functionality
function initializeAudioUpload() {
    const audioMethodRadios = document.querySelectorAll('input[name="audio_method"]');
    const manualAudioSection = document.getElementById('manual-audio-section');
    const audioFilesInput = document.getElementById('audio-files');
    const audioFileList = document.getElementById('audio-file-list');
    const audioFilesContainer = document.getElementById('audio-files-container');
    
    // Handle audio method selection
    audioMethodRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.value === 'manual') {
                manualAudioSection.style.display = 'block';
            } else {
                manualAudioSection.style.display = 'none';
                uploadedAudioFiles.clear();
                audioFileList.style.display = 'none';
            }
        });
    });
    
    // Handle file selection
    audioFilesInput.addEventListener('change', function(e) {
        handleAudioFiles(e.target.files);
    });
    
    // Handle drag and drop
    manualAudioSection.addEventListener('dragover', function(e) {
        e.preventDefault();
        this.classList.add('border-primary-500', 'bg-primary-50');
    });
    
    manualAudioSection.addEventListener('dragleave', function(e) {
        e.preventDefault();
        this.classList.remove('border-primary-500', 'bg-primary-50');
    });
    
    manualAudioSection.addEventListener('drop', function(e) {
        e.preventDefault();
        this.classList.remove('border-primary-500', 'bg-primary-50');
        handleAudioFiles(e.dataTransfer.files);
    });
}

// Handle audio file processing
function handleAudioFiles(files) {
    const supportedFormats = ['.mp3', '.wav', '.aac', '.m4a'];
    const maxFileSize = 50 * 1024 * 1024; // 50MB
    
    Array.from(files).forEach(file => {
        const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
        
        // Validate file format
        if (!supportedFormats.includes(fileExtension)) {
            showNotification(`File "${file.name}" has unsupported format. Supported: MP3, WAV, AAC, M4A`, 'error');
            return;
        }
        
        // Validate file size
        if (file.size > maxFileSize) {
            showNotification(`File "${file.name}" is too large. Maximum size: 50MB`, 'error');
            return;
        }
        
        // Store file for upload
        const fileId = generateFileId();
        uploadedAudioFiles.set(fileId, {
            file: file,
            name: file.name,
            size: file.size,
            status: 'pending'
        });
        
        displayAudioFile(fileId, file);
    });
    
    if (uploadedAudioFiles.size > 0) {
        document.getElementById('audio-file-list').style.display = 'block';
    }
}

// Display uploaded audio file
function displayAudioFile(fileId, file) {
    const container = document.getElementById('audio-files-container');
    const fileDiv = document.createElement('div');
    fileDiv.id = `file-${fileId}`;
    fileDiv.className = 'flex items-center justify-between p-3 bg-white border rounded-lg';
    
    fileDiv.innerHTML = `
        <div class="flex items-center space-x-3">
            <svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"></path>
            </svg>
            <div>
                <p class="text-sm font-medium text-gray-900">${file.name}</p>
                <p class="text-xs text-gray-500">${formatFileSize(file.size)}</p>
            </div>
        </div>
        <div class="flex items-center space-x-2">
            <span id="status-${fileId}" class="text-xs text-gray-500">Ready</span>
            <button type="button" onclick="removeAudioFile('${fileId}')" class="text-red-500 hover:text-red-700">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
    `;
    
    container.appendChild(fileDiv);
}

// Remove audio file
function removeAudioFile(fileId) {
    uploadedAudioFiles.delete(fileId);
    document.getElementById(`file-${fileId}`).remove();
    
    if (uploadedAudioFiles.size === 0) {
        document.getElementById('audio-file-list').style.display = 'none';
    }
}

// Prompt management functionality
function initializePromptManagement() {
    const createCustomPromptBtn = document.getElementById('create-custom-prompt');
    
    createCustomPromptBtn.addEventListener('click', function() {
        showCustomPromptModal();
    });
}

// Load available prompts
async function loadAvailablePrompts() {
    try {
        const response = await fetch('/api/prompts/list');
        const data = await response.json();
        
        if (data.success) {
            availablePrompts = data.prompts;
            populatePromptSelects();
        }
    } catch (error) {
        console.error('Failed to load prompts:', error);
    }
}

// Populate prompt selection dropdowns
function populatePromptSelects() {
    const stage3Select = document.getElementById('stage3-prompt');
    const stage4Select = document.getElementById('stage4-prompt');
    
    // Clear existing options
    stage3Select.innerHTML = '<option value="">Select analysis prompt...</option>';
    stage4Select.innerHTML = '<option value="">Select narrative prompt...</option>';
    
    // Populate Stage 3 prompts
    availablePrompts.stage3.forEach(prompt => {
        const option = document.createElement('option');
        option.value = prompt.id;
        option.textContent = prompt.name;
        stage3Select.appendChild(option);
    });
    
    // Populate Stage 4 prompts
    availablePrompts.stage4.forEach(prompt => {
        const option = document.createElement('option');
        option.value = prompt.id;
        option.textContent = prompt.name;
        stage4Select.appendChild(option);
    });
}

// Utility functions
function generateFileId() {
    return 'audio_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function showNotification(message, type = 'info') {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg max-w-sm ${
        type === 'error' ? 'bg-red-500 text-white' : 'bg-blue-500 text-white'
    }`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    // Remove after 5 seconds
    setTimeout(() => {
        notification.remove();
    }, 5000);
}

function showCustomPromptModal() {
    // TODO: Implement custom prompt creation modal
    showNotification('Custom prompt creation feature coming soon!', 'info');
}

// Pipeline form submission
document.getElementById('pipeline-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const selectedStages = Array.from(document.querySelectorAll('input[name="selected_stages"]:checked'))
        .map(cb => cb.value);
    
    formData.append('selected_stages', JSON.stringify(selectedStages));
    
    // Handle audio method and files
    const audioMethod = document.querySelector('input[name="audio_method"]:checked').value;
    formData.append('audio_method', audioMethod);
    
    if (audioMethod === 'manual' && uploadedAudioFiles.size > 0) {
        // Upload audio files first
        const uploadSuccess = await uploadAudioFiles();
        if (!uploadSuccess) {
            showNotification('Failed to upload audio files', 'error');
            return;
        }
    }
    
    // Show status section
    const statusSection = document.getElementById('pipeline-status');
    const statusContent = document.getElementById('status-content');
    
    statusSection.classList.remove('hidden');
    statusContent.innerHTML = `
        <div class="bg-blue-50 border border-blue-200 rounded p-4">
            <h4 class="font-medium text-blue-800">STARTING</h4>
            <p class="text-blue-700">Initializing pipeline execution...</p>
        </div>
    `;
    
    // Submit pipeline execution
    fetch('/pipeline/execute', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        statusContent.innerHTML = `
            <div class="bg-green-50 border border-green-200 rounded p-4">
                <h4 class="font-medium text-green-800">${data.status.toUpperCase()}</h4>
                <p class="text-green-700">${data.message}</p>
                <p class="text-sm text-green-600 mt-2">${data.note}</p>
            </div>
        `;
    })
    .catch(error => {
        console.error('Pipeline execution error:', error);
        
        statusContent.innerHTML = `
            <div class="bg-red-50 border border-red-200 rounded p-4">
                <h4 class="font-medium text-red-800">ERROR</h4>
                <p class="text-red-700">Pipeline execution failed: ${error.message}</p>
            </div>
        `;
    });
});

// Upload audio files to server
async function uploadAudioFiles() {
    const uploadProgress = document.getElementById('upload-progress');
    const uploadStatus = document.getElementById('upload-status');
    const uploadPercentage = document.getElementById('upload-percentage');
    const uploadProgressBar = document.getElementById('upload-progress-bar');
    
    uploadProgress.style.display = 'block';
    
    const totalFiles = uploadedAudioFiles.size;
    let uploadedCount = 0;
    
    for (const [fileId, fileData] of uploadedAudioFiles) {
        try {
            const formData = new FormData();
            formData.append('audio_file', fileData.file);
            formData.append('file_id', fileId);
            
            const response = await fetch('/api/audio/upload', {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (result.success) {
                fileData.status = 'uploaded';
                document.getElementById(`status-${fileId}`).textContent = 'Uploaded';
                document.getElementById(`status-${fileId}`).className = 'text-xs text-green-600';
            } else {
                throw new Error(result.error || 'Upload failed');
            }
            
        } catch (error) {
            fileData.status = 'failed';
            document.getElementById(`status-${fileId}`).textContent = 'Failed';
            document.getElementById(`status-${fileId}`).className = 'text-xs text-red-600';
            console.error(`Failed to upload ${fileData.name}:`, error);
        }
        
        uploadedCount++;
        const percentage = Math.round((uploadedCount / totalFiles) * 100);
        uploadPercentage.textContent = `${percentage}%`;
        uploadProgressBar.style.width = `${percentage}%`;
        uploadStatus.textContent = `Uploaded ${uploadedCount} of ${totalFiles} files`;
    }
    
    uploadProgress.style.display = 'none';
    
    // Check if all uploads succeeded
    const failedUploads = Array.from(uploadedAudioFiles.values())
        .filter(file => file.status === 'failed');
    
    return failedUploads.length === 0;
}
</script>
{% endblock %}
