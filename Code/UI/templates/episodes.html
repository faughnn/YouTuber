{% extends "base.html" %}

{% block title %}Episodes - YouTube Pipeline UI{% endblock %}

{% block content %}
<div class="px-4 py-6 sm:px-6 lg:px-8">
    <!-- Page header with enhanced responsive design -->
    <div class="md:flex md:items-center md:justify-between mb-8 fade-in">
        <div class="flex-1 min-w-0">
            <h1 class="text-2xl sm:text-3xl lg:text-4xl font-bold text-gray-900 transition-all duration-300">
                Episode Management
            </h1>
            <p class="mt-2 text-sm sm:text-base text-gray-600 max-w-2xl">
                Browse, search, and manage your content episodes with enhanced filtering and organization
            </p>
        </div>
        <div class="mt-4 flex flex-col sm:flex-row sm:space-x-3 space-y-2 sm:space-y-0 md:mt-0 md:ml-4">
            <button type="button" 
                    id="search-episodes" 
                    class="btn-secondary inline-flex items-center justify-center space-x-2"
                    aria-label="Search episodes"
                    data-tooltip="Search and filter episodes">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
                <span>Search</span>
            </button>
            <button type="button" 
                    id="refresh-episodes" 
                    class="btn-primary inline-flex items-center justify-center space-x-2"
                    aria-label="Refresh episodes data"
                    data-tooltip="Refresh episode list and statistics">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                </svg>
                <span>Refresh</span>
            </button>
        </div>
    </div>    <!-- Statistics Cards with enhanced responsive design and accessibility -->
    {% if stats %}
    <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-4 mb-8 fade-in">
        <!-- Total Episodes -->
        <div class="stat-card group" role="article" aria-labelledby="total-episodes-title">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center group-hover:bg-blue-200 transition-colors duration-200">
                            <svg class="h-6 w-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
                            </svg>
                        </div>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt id="total-episodes-title" class="text-sm font-medium text-gray-500 truncate">Total Episodes</dt>
                            <dd class="text-2xl font-bold text-gray-900 tabular-nums">{{ stats.total_episodes }}</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <!-- Shows Count -->
        <div class="stat-card group" role="article" aria-labelledby="total-shows-title">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center group-hover:bg-green-200 transition-colors duration-200">
                            <svg class="h-6 w-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14-7l-2 2m2-2l-2-2m2 2l-9 9a2 2 0 01-2.828 0L4 10a2 2 0 010-2.828l4.172-4.172A2 2 0 0110 2h4.172a2 2 0 011.414.586L19 6v5z" />
                            </svg>
                        </div>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt id="total-shows-title" class="text-sm font-medium text-gray-500 truncate">Total Shows</dt>
                            <dd class="text-2xl font-bold text-gray-900 tabular-nums">{{ stats.total_shows }}</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <!-- Completed Episodes -->
        <div class="stat-card group" role="article" aria-labelledby="completed-episodes-title">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-10 h-10 bg-emerald-100 rounded-lg flex items-center justify-center group-hover:bg-emerald-200 transition-colors duration-200">
                            <svg class="h-6 w-6 text-emerald-600" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                            </svg>
                        </div>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt id="completed-episodes-title" class="text-sm font-medium text-gray-500 truncate">Completed</dt>
                            <dd class="text-2xl font-bold text-gray-900 tabular-nums">{{ stats.status_counts.get('Completed', 0) }}</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <!-- In Progress Episodes -->
        <div class="stat-card group" role="article" aria-labelledby="in-progress-episodes-title">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-10 h-10 bg-yellow-100 rounded-lg flex items-center justify-center group-hover:bg-yellow-200 transition-colors duration-200">
                            <svg class="h-6 w-6 text-yellow-600" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" />
                            </svg>
                        </div>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt id="in-progress-episodes-title" class="text-sm font-medium text-gray-500 truncate">In Progress</dt>
                            <dd class="text-2xl font-bold text-gray-900 tabular-nums">{{ stats.status_counts.get('In Progress', 0) }}</dd>
                        </dl>
                    </div>
                </div>
            </div>        </div>
    </div>
    {% endif %}
    
    <!-- Filters and Search with enhanced design -->
    <div class="bg-white shadow-lg rounded-xl mb-8 fade-in" role="region" aria-labelledby="filters-title">
        <div class="px-6 py-6 sm:p-8">
            <div class="flex items-center justify-between mb-6">
                <h3 id="filters-title" class="text-lg font-semibold text-gray-900">Search & Filter</h3>
                <button type="button" 
                        id="clear-filters" 
                        class="text-sm text-gray-500 hover:text-gray-700 transition-colors duration-200"
                        aria-label="Clear all filters">
                    Clear all
                </button>
            </div>
            <form id="episode-filters" class="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-4">
                <!-- Search -->
                <div class="sm:col-span-2 lg:col-span-2">
                    <label for="search" class="block text-sm font-medium text-gray-700 mb-2">Search Episodes</label>
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg class="h-5 w-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
                                <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                            </svg>
                        </div>
                        <input type="text" 
                               id="search" 
                               name="search" 
                               value="{{ search_query }}" 
                               class="form-input pl-10 w-full"
                               placeholder="Search episodes by title, show, or episode number..."
                               aria-describedby="search-help">
                        <button type="button" 
                                id="clear-search" 
                                class="absolute inset-y-0 right-0 pr-3 flex items-center {% if not search_query %}hidden{% endif %}"
                                aria-label="Clear search">
                            <svg class="h-4 w-4 text-gray-400 hover:text-gray-600" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                    <p id="search-help" class="mt-1 text-xs text-gray-500">Search by title, show name, or episode number</p>
                </div>

                <!-- Show Filter -->
                <div>
                    <label for="show-filter" class="block text-sm font-medium text-gray-700 mb-2">Show</label>
                    <select id="show-filter" 
                            name="show" 
                            class="form-select w-full"
                            aria-describedby="show-filter-help">
                        <option value="">All Shows</option>
                        {% for show in shows %}
                            <option value="{{ show }}" {% if show == show_filter %}selected{% endif %}>{{ show }}</option>
                        {% endfor %}
                    </select>
                    <p id="show-filter-help" class="mt-1 text-xs text-gray-500">Filter by show name</p>
                </div>

                <!-- Status Filter -->
                <div>
                    <label for="status-filter" class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                    <select id="status-filter" 
                            name="status" 
                            class="form-select w-full"
                            aria-describedby="status-filter-help">
                        <option value="">All Statuses</option>
                        <option value="Not Started" {% if status_filter == 'Not Started' %}selected{% endif %}>Not Started</option>
                        <option value="In Progress" {% if status_filter == 'In Progress' %}selected{% endif %}>In Progress</option>
                        <option value="Completed" {% if status_filter == 'Completed' %}selected{% endif %}>Completed</option>
                    </select>
                    <p id="status-filter-help" class="mt-1 text-xs text-gray-500">Filter by processing status</p>
                </div>
            </form>
        </div>
    </div>    <!-- Episodes Grid with enhanced design -->
    <div id="episodes-container" class="fade-in">
        {% if episodes %}
            <div class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4" role="grid" aria-label="Episodes list">
                {% for episode in episodes %}
                    <article class="card-interactive episode-card bg-white rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1" 
                             data-episode-id="{{ episode.episode_id }}"
                             role="gridcell"
                             aria-labelledby="episode-title-{{ loop.index }}"
                             tabindex="0">
                        <div class="p-6">
                            <!-- Episode Header -->
                            <div class="flex items-start justify-between mb-4">
                                <div class="flex-1 min-w-0">
                                    <h3 id="episode-title-{{ loop.index }}" 
                                        class="text-lg font-semibold text-gray-900 truncate group-hover:text-primary-600 transition-colors duration-200" 
                                        title="{{ episode.episode_title }}">
                                        {% if episode.episode_number %}
                                            <span class="text-primary-600 font-bold">#{{ episode.episode_number }}</span>
                                        {% endif %}
                                        {{ episode.episode_title[:50] }}{% if episode.episode_title|length > 50 %}...{% endif %}
                                    </h3>
                                    <p class="text-sm text-gray-600 mt-1 font-medium">{{ episode.show_name }}</p>
                                </div>
                                
                                <!-- Status Badge -->
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold
                                    {% if episode.processing_status == 'Completed' %}badge-success
                                    {% elif episode.processing_status == 'In Progress' %}badge-warning
                                    {% else %}badge-gray{% endif %}"
                                    aria-label="Processing status: {{ episode.processing_status }}">
                                    {{ episode.processing_status }}
                                </span>
                            </div>

                            <!-- Progress Bar with enhanced accessibility -->
                            <div class="mb-4">
                                <div class="flex justify-between text-sm text-gray-600 mb-2">
                                    <span class="font-medium">Pipeline Progress</span>
                                    <span class="tabular-nums" aria-label="{{ episode.stages_completed|length }} of {{ episode.stages_total }} stages completed">
                                        {{ episode.stages_completed|length }}/{{ episode.stages_total }}
                                    </span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
                                    {% set progress = (episode.stages_completed|length * 100 / episode.stages_total)|round(1) if episode.stages_total > 0 else 0 %}                                    <div class="h-full rounded-full transition-all duration-500 ease-out
                                        {% if episode.stages_completed|length == episode.stages_total %}bg-gradient-to-r from-green-500 to-green-600
                                        {% elif episode.stages_completed|length > 0 %}bg-gradient-to-r from-blue-500 to-blue-600
                                        {% else %}bg-gray-400{% endif %}"
                                        data-progress="{{ progress }}"
                                        role="progressbar"
                                        aria-valuenow="{{ progress }}"
                                        aria-valuemin="0"
                                        aria-valuemax="100"
                                        aria-label="Pipeline progress: {{ progress }}% complete">
                                    </div>
                                </div>
                            </div>

                            <!-- Episode Metadata -->
                            <div class="space-y-2 mb-4">
                                {% if episode.duration %}
                                    <div class="flex items-center text-sm text-gray-600">
                                        <svg class="h-4 w-4 mr-2 text-gray-400" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
                                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" />
                                        </svg>
                                        <span>{{ episode.duration }}</span>
                                    </div>
                                {% endif %}
                                
                                {% if episode.last_processed %}
                                    <div class="flex items-center text-sm text-gray-600">
                                        <svg class="h-4 w-4 mr-2 text-gray-400" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
                                            <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" />
                                        </svg>
                                        <span>{{ episode.last_processed }}</span>
                                    </div>
                                {% endif %}
                            </div>

                            <!-- Action Buttons with enhanced accessibility -->
                            <div class="grid grid-cols-1 gap-2">
                                <button type="button" 
                                        class="process-episode-btn btn-primary w-full text-sm py-2.5 {{ 'opacity-50 cursor-not-allowed' if episode.active_sessions }}"
                                        data-episode-id="{{ episode.episode_id }}"
                                        aria-label="Process episode {{ episode.episode_title }}"
                                        {{ 'disabled' if episode.active_sessions }}>
                                    {% if episode.active_sessions %}
                                        <svg class="w-4 h-4 mr-2 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                        </svg>
                                        Processing...
                                    {% else %}
                                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h1m4 0h1M9 16h6m-7 4h8a2 2 0 002-2V6a2 2 0 00-2-2H8a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                        </svg>
                                        Process Episode
                                    {% endif %}
                                </button>
                                
                                <div class="grid grid-cols-2 gap-2">
                                    <button type="button" 
                                            class="select-segments-btn btn-success text-sm py-2 {{ 'opacity-50 cursor-not-allowed' if not episode.has_analysis }}"
                                            data-episode-path="{{ episode.path }}"
                                            aria-label="Select segments for {{ episode.episode_title }}"
                                            {{ 'disabled' if not episode.has_analysis }}>
                                        {% if episode.has_analysis %}
                                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
                                            </svg>
                                            Segments
                                        {% else %}
                                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728L5.636 5.636m12.728 12.728L18.364 5.636M5.636 18.364l12.728-12.728" />
                                            </svg>
                                            No Analysis
                                        {% endif %}
                                    </button>
                                    
                                    <button type="button" 
                                            class="view-details-btn btn-secondary text-sm py-2"
                                            data-episode-id="{{ episode.episode_id }}"
                                            aria-label="View details for {{ episode.episode_title }}">
                                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                        </svg>
                                        Details
                                    </button>
                                </div>
                            </div>
                        </div>
                    </article>
                {% endfor %}
            </div>
        {% else %}
            <!-- Empty State with enhanced design -->
            <div class="text-center py-16 bg-white rounded-xl shadow-sm">
                <div class="mx-auto h-16 w-16 text-gray-400 mb-6">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 48 48" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M34 40h10v-4a6 6 0 00-10.712-3.714M34 40H14m20 0v-4a9.971 9.971 0 00-.712-3.714M14 40H4v-4a6 6 0 0110.713-3.714M14 40v-4c0-1.313.253-2.566.713-3.714m0 0A9.971 9.971 0 0121 28c4.418 0 7.865 2.79 9.287 6.286" />
                    </svg>
                </div>
                <h3 class="text-lg font-semibold text-gray-900 mb-2">No episodes found</h3>
                <p class="text-gray-600 mb-6 max-w-md mx-auto">
                    {% if search_query or show_filter or status_filter %}
                        No episodes match your current search criteria. Try adjusting your filters or search terms.
                    {% else %}
                        Episodes will appear here when you add content to the Content directory.
                    {% endif %}
                </p>
                {% if not search_query and not show_filter and not status_filter %}
                    <button type="button" 
                            id="refresh-episodes-empty" 
                            class="btn-primary inline-flex items-center space-x-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                        </svg>
                        <span>Refresh Episodes</span>
                    </button>
                {% else %}
                    <button type="button" 
                            id="clear-all-filters" 
                            class="btn-secondary inline-flex items-center space-x-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                        <span>Clear Filters</span>
                    </button>
                {% endif %}
            </div>
        {% endif %}
    </div>
</div>

<!-- Episode Details Modal -->
<div id="episode-modal" class="fixed inset-0 z-50 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="sm:flex sm:items-start">
                    <div class="mt-3 text-center sm:mt-0 sm:text-left w-full">
                        <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">Episode Details</h3>
                        <div class="mt-4" id="episode-details-content">
                            <!-- Episode details will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button type="button" id="close-modal" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Episode Processing Modal -->
<div id="processing-modal" class="fixed inset-0 z-50 overflow-y-auto hidden" aria-labelledby="processing-modal-title" role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-2xl sm:w-full">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="sm:flex sm:items-start">
                    <div class="mt-3 text-center sm:mt-0 sm:text-left w-full">
                        <h3 class="text-lg leading-6 font-medium text-gray-900" id="processing-modal-title">Process Episode</h3>
                        <div class="mt-4">
                            <div id="processing-episode-info" class="mb-4">
                                <!-- Episode info will be loaded here -->
                            </div>
                            
                            <div class="mb-6">
                                <label class="text-base font-medium text-gray-900">Select Pipeline Stages</label>
                                <p class="text-sm leading-5 text-gray-500">Choose which stages to execute for this episode</p>
                                <fieldset class="mt-4">
                                    <div class="space-y-4">
                                        <div class="flex items-start">
                                            <div class="flex items-center h-5">
                                                <input id="stage-1" name="stages" type="checkbox" value="1" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300 rounded" checked>
                                            </div>
                                            <div class="ml-3 text-sm">
                                                <label for="stage-1" class="font-medium text-gray-700">Stage 1: Media Extraction</label>
                                                <p class="text-gray-500">Extract audio and analyze media content</p>
                                            </div>
                                        </div>
                                        <div class="flex items-start">
                                            <div class="flex items-center h-5">
                                                <input id="stage-2" name="stages" type="checkbox" value="2" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300 rounded" checked>
                                            </div>
                                            <div class="ml-3 text-sm">
                                                <label for="stage-2" class="font-medium text-gray-700">Stage 2: Transcript Generation</label>
                                                <p class="text-gray-500">Generate transcript from audio content</p>
                                            </div>
                                        </div>
                                        <div class="flex items-start">
                                            <div class="flex items-center h-5">
                                                <input id="stage-3" name="stages" type="checkbox" value="3" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300 rounded" checked>
                                            </div>
                                            <div class="ml-3 text-sm">
                                                <label for="stage-3" class="font-medium text-gray-700">Stage 3: Content Analysis</label>
                                                <p class="text-gray-500">Analyze content and identify key segments</p>
                                            </div>
                                        </div>
                                        <div class="flex items-start">
                                            <div class="flex items-center h-5">
                                                <input id="stage-4" name="stages" type="checkbox" value="4" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300 rounded" checked>
                                            </div>
                                            <div class="ml-3 text-sm">
                                                <label for="stage-4" class="font-medium text-gray-700">Stage 4: Narrative Generation</label>
                                                <p class="text-gray-500">Generate narrative structure and segment selection</p>
                                            </div>
                                        </div>
                                        <div class="flex items-start">
                                            <div class="flex items-center h-5">
                                                <input id="stage-5" name="stages" type="checkbox" value="5" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300 rounded" checked>
                                            </div>
                                            <div class="ml-3 text-sm">
                                                <label for="stage-5" class="font-medium text-gray-700">Stage 5: Audio Generation</label>
                                                <p class="text-gray-500">Generate TTS audio for selected segments</p>
                                            </div>
                                        </div>
                                        <div class="flex items-start">
                                            <div class="flex items-center h-5">
                                                <input id="stage-6" name="stages" type="checkbox" value="6" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300 rounded" checked>
                                            </div>
                                            <div class="ml-3 text-sm">
                                                <label for="stage-6" class="font-medium text-gray-700">Stage 6: Video Clipping</label>
                                                <p class="text-gray-500">Create video clips for selected segments</p>
                                            </div>
                                        </div>
                                        <div class="flex items-start">
                                            <div class="flex items-center h-5">
                                                <input id="stage-7" name="stages" type="checkbox" value="7" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300 rounded" checked>
                                            </div>
                                            <div class="ml-3 text-sm">
                                                <label for="stage-7" class="font-medium text-gray-700">Stage 7: Video Compilation</label>
                                                <p class="text-gray-500">Compile final video output</p>
                                            </div>
                                        </div>
                                    </div>
                                </fieldset>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button type="button" id="start-processing-btn" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 sm:ml-3 sm:w-auto sm:text-sm">
                    Start Processing
                </button>
                <button type="button" id="cancel-processing-btn" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:w-auto sm:text-sm">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>
<script>
    // Enhanced Episodes Management with improved accessibility and performance
    class EpisodesManager {
        constructor() {
            this.searchTimeout = null;
            this.currentPage = 1;
            this.isLoading = false;
            this.init();
        }

        init() {
            this.bindEvents();
            this.initializeProgressBars();
            this.initializeTooltips();
            this.setupAccessibility();
            this.initializeFilters();
        }

        bindEvents() {
            // Refresh button
            const refreshBtn = document.getElementById('refresh-episodes');
            const refreshBtnEmpty = document.getElementById('refresh-episodes-empty');
            
            [refreshBtn, refreshBtnEmpty].forEach(btn => {
                if (btn) {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        this.refreshEpisodes();
                    });
                }
            });

            // Search input with debouncing
            const searchInput = document.getElementById('search');
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    clearTimeout(this.searchTimeout);
                    this.searchTimeout = setTimeout(() => {
                        this.performSearch();
                    }, 300);
                });
            }

            // Filter changes
            const showFilter = document.getElementById('show-filter');
            const statusFilter = document.getElementById('status-filter');
            
            [showFilter, statusFilter].forEach(filter => {
                if (filter) {
                    filter.addEventListener('change', () => {
                        this.performSearch();
                    });
                }
            });

            // Clear filters
            const clearFiltersBtn = document.getElementById('clear-filters');
            const clearAllFiltersBtn = document.getElementById('clear-all-filters');
            
            [clearFiltersBtn, clearAllFiltersBtn].forEach(btn => {
                if (btn) {
                    btn.addEventListener('click', () => {
                        this.clearAllFilters();
                    });
                }
            });

            // Episode action buttons
            this.bindEpisodeActions();
        }

        bindEpisodeActions() {
            // Process episode buttons
            document.querySelectorAll('.process-episode-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const episodeId = btn.getAttribute('data-episode-id');
                    if (episodeId && !btn.disabled) {
                        this.processEpisode(episodeId, btn);
                    }
                });
            });

            // Select segments buttons
            document.querySelectorAll('.select-segments-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const episodePath = btn.getAttribute('data-episode-path');
                    if (episodePath && !btn.disabled) {
                        this.selectSegments(episodePath);
                    }
                });
            });

            // View details buttons
            document.querySelectorAll('.view-details-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const episodeId = btn.getAttribute('data-episode-id');
                    if (episodeId) {
                        this.viewEpisodeDetails(episodeId);
                    }
                });
            });
        }

        async refreshEpisodes() {
            const refreshBtns = document.querySelectorAll('[id*="refresh-episodes"]');
            const originalContent = {};
            
            try {
                // Show loading state
                refreshBtns.forEach(btn => {
                    originalContent[btn.id] = btn.innerHTML;
                    btn.disabled = true;
                    btn.innerHTML = `
                        <svg class="w-4 h-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                        </svg>
                        <span>Refreshing...</span>
                    `;
                });

                // Add global loading overlay if available
                if (window.uiEnhancements?.showGlobalLoading) {
                    window.uiEnhancements.showGlobalLoading('Refreshing episodes...');
                }

                // Simulate API call delay for user feedback
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Reload the page to get fresh data
                window.location.reload();

            } catch (error) {
                console.error('Episodes refresh failed:', error);
                if (window.uiEnhancements?.showToast) {
                    window.uiEnhancements.showToast('Failed to refresh episodes', 'error');
                }
                
                // Restore button states
                refreshBtns.forEach(btn => {
                    btn.disabled = false;
                    btn.innerHTML = originalContent[btn.id];
                });
                
                if (window.uiEnhancements?.hideGlobalLoading) {
                    window.uiEnhancements.hideGlobalLoading();
                }
            }
        }

        performSearch() {
            if (this.isLoading) return;
            
            const searchForm = document.getElementById('episode-filters');
            if (!searchForm) return;

            const formData = new FormData(searchForm);
            const params = new URLSearchParams();
            
            for (let [key, value] of formData.entries()) {
                if (value.trim()) {
                    params.append(key, value);
                }
            }

            // Update URL and reload with new parameters
            const newUrl = `${window.location.pathname}?${params.toString()}`;
            window.history.pushState({}, '', newUrl);
            window.location.reload();
        }

        clearAllFilters() {
            document.getElementById('search').value = '';
            document.getElementById('show-filter').value = '';
            document.getElementById('status-filter').value = '';
            
            // Update URL and reload
            window.history.pushState({}, '', window.location.pathname);
            window.location.reload();
        }

        async processEpisode(episodeId, button) {
            try {
                const originalContent = button.innerHTML;
                
                // Show loading state
                button.disabled = true;
                button.innerHTML = `
                    <svg class="w-4 h-4 animate-spin mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                    Starting...
                `;

                // Simulate API call - replace with actual API endpoint
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                if (window.uiEnhancements?.showToast) {
                    window.uiEnhancements.showToast('Processing started successfully!', 'success');
                }
                
                // Update button to show processing state
                button.innerHTML = `
                    <svg class="w-4 h-4 animate-spin mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                    Processing...
                `;
                
                // Refresh page after delay to show updated status
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
                
            } catch (error) {
                console.error('Error processing episode:', error);
                if (window.uiEnhancements?.showToast) {
                    window.uiEnhancements.showToast(`Error starting processing: ${error.message}`, 'error');
                }
                
                // Restore button state
                button.disabled = false;
                button.innerHTML = originalContent;
            }
        }

        selectSegments(episodePath) {
            // Navigate to segments selection for this episode
            const segmentsUrl = `{{ url_for('segments.segments_dashboard') }}?episode_path=${encodeURIComponent(episodePath)}`;
            window.location.href = segmentsUrl;
        }

        async viewEpisodeDetails(episodeId) {
            try {
                if (window.uiEnhancements?.showGlobalLoading) {
                    window.uiEnhancements.showGlobalLoading('Loading episode details...');
                }
                
                // Simulate API call - replace with actual endpoint
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                if (window.uiEnhancements?.showToast) {
                    window.uiEnhancements.showToast('Episode details feature coming soon!', 'info');
                }
                
            } catch (error) {
                console.error('Error loading episode details:', error);
                if (window.uiEnhancements?.showToast) {
                    window.uiEnhancements.showToast(`Error loading details: ${error.message}`, 'error');
                }
            } finally {
                if (window.uiEnhancements?.hideGlobalLoading) {
                    window.uiEnhancements.hideGlobalLoading();
                }
            }
        }

        initializeProgressBars() {
            // Animate progress bars on page load
            document.querySelectorAll('[role="progressbar"]').forEach((bar, index) => {
                const widthMatch = bar.style.width?.match(/(\d+(?:\.\d+)?)%/) || 
                                  bar.getAttribute('style')?.match(/width:\s*(\d+(?:\.\d+)?)%/);
                
                if (widthMatch) {
                    const width = widthMatch[1];
                    // Animate with a slight delay for each bar
                    setTimeout(() => {
                        bar.style.width = '0%';
                        bar.style.transition = 'width 1s ease-out';
                        setTimeout(() => {
                            bar.style.width = `${width}%`;
                        }, 50);
                    }, index * 100);
                }
            });
        }

        initializeTooltips() {
            // Initialize tooltips for elements with data-tooltip attribute
            const tooltipElements = document.querySelectorAll('[data-tooltip]');
            tooltipElements.forEach(element => {
                if (window.uiEnhancements?.initTooltip) {
                    window.uiEnhancements.initTooltip(element);
                }
            });
        }

        initializeFilters() {
            // Show/hide clear search button based on search input
            const searchInput = document.getElementById('search');
            const clearSearchBtn = document.getElementById('clear-search');
            
            if (searchInput && clearSearchBtn) {
                const toggleClearButton = () => {
                    clearSearchBtn.classList.toggle('hidden', !searchInput.value.trim());
                };
                
                searchInput.addEventListener('input', toggleClearButton);
                toggleClearButton(); // Initial state
            }
        }

        setupAccessibility() {
            // Enhanced keyboard navigation
            document.addEventListener('keydown', (e) => {
                // Quick actions with Alt key
                if (e.altKey) {
                    switch(e.key) {
                        case 'r':
                            e.preventDefault();
                            document.getElementById('refresh-episodes')?.click();
                            break;
                        case 's':
                            e.preventDefault();
                            document.getElementById('search')?.focus();
                            break;
                        case 'c':
                            e.preventDefault();
                            this.clearAllFilters();
                            break;
                    }
                }

                // Escape key to clear search
                if (e.key === 'Escape') {
                    const searchInput = document.getElementById('search');
                    if (searchInput && searchInput === document.activeElement) {
                        searchInput.value = '';
                        this.performSearch();
                    }
                }
            });

            // Focus management for episode cards
            const episodeCards = document.querySelectorAll('.episode-card');
            episodeCards.forEach((card, index) => {
                card.addEventListener('keydown', (e) => {
                    let targetIndex = index;
                    
                    switch(e.key) {
                        case 'ArrowDown':
                        case 'ArrowRight':
                            e.preventDefault();
                            targetIndex = Math.min(index + 1, episodeCards.length - 1);
                            break;
                        case 'ArrowUp':
                        case 'ArrowLeft':
                            e.preventDefault();
                            targetIndex = Math.max(index - 1, 0);
                            break;
                        case 'Home':
                            e.preventDefault();
                            targetIndex = 0;
                            break;
                        case 'End':
                            e.preventDefault();
                            targetIndex = episodeCards.length - 1;
                            break;
                        case 'Enter':
                        case ' ':
                            e.preventDefault();
                            const detailsBtn = card.querySelector('.view-details-btn');
                            if (detailsBtn) {
                                detailsBtn.click();
                            }
                            break;
                    }
                    
                    if (targetIndex !== index && episodeCards[targetIndex]) {
                        episodeCards[targetIndex].focus();
                    }
                });
            });
        }
    }

    // Initialize episodes manager when DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
        new EpisodesManager();
    });
</script>
{% endblock %}
